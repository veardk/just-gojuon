(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[401],{320:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});var i=a(4297);let n=(0,i.Z)("PenTool",[["path",{d:"m12 19 7-7 3 3-7 7-3-3z",key:"rklqx2"}],["path",{d:"m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z",key:"1et58u"}],["path",{d:"m2 2 7.586 7.586",key:"etlp93"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]])},1578:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/practice/dictation/session",function(){return a(795)}])},795:function(e,t,a){"use strict";a.r(t);var i=a(5893),n=a(7294),s=a(9008),r=a.n(s),o=a(1163),l=a(9556),c=a(5274),u=a(4148),d=a(4752),m=a(4848),x=a(5817),g=a(320);t.default=()=>{var e;let t=(0,o.useRouter)(),a=(0,l.ZK)(),s=(0,c.m)(),h=(0,c.NT)(),p=(0,c.o9)(),{pauseDictation:f,resumeDictation:y,stopDictation:A,nextAudio:v,previousAudio:j,updateTimer:N,recordAudioPlayed:k,updateCurrentRepeat:T}=(0,c.Uf)(),C=(0,n.useRef)(null),P=(0,n.useRef)(),[S,D]=(0,n.useState)(!1),getProgress=()=>{let e=60*h.duration,t=e-s.remainingTime;return Math.round(t/e*100)};(0,n.useEffect)(()=>(s.isActive&&!s.isPaused?P.current=setInterval(()=>{N()},1e3):P.current&&clearInterval(P.current),()=>{P.current&&clearInterval(P.current)}),[s.isActive,s.isPaused,N]);let I=(0,n.useCallback)(()=>{v()},[v]);return((0,n.useEffect)(()=>{if(!p||!C.current)return;let e=C.current;e.volume=h.audioSettings.volume,e.playbackRate=h.audioSettings.playbackRate;let t=!0,playAudio=async()=>{if(s.isActive&&!s.isPaused&&t)try{D(!0),await e.play()}catch(e){console.error("音频播放失败:",e),D(!1),t&&setTimeout(()=>{handleAudioEnd()},1e3)}},handleAudioEnd=()=>{if(!t)return;D(!1);let e=s.currentRepeat+1;console.log("Audio ended, current repeat:",s.currentRepeat,"next repeat:",e,"max repeats:",h.audioSettings.repeatCount),e<h.audioSettings.repeatCount?(T(e),setTimeout(()=>{s.isActive&&!s.isPaused&&t&&(console.log("Replaying current audio, repeat:",e),playAudio())},1e3*h.audioSettings.intervalTime)):(p&&k(p,h.audioSettings.repeatCount),console.log("Moving to next audio"),setTimeout(()=>{s.isActive&&!s.isPaused&&t&&I()},1e3*h.audioSettings.intervalTime))},handleAudioError=()=>{t&&(console.warn("音频加载失败:",null==p?void 0:p.audioUrl),D(!1),setTimeout(()=>{t&&handleAudioEnd()},500))};return e.addEventListener("ended",handleAudioEnd),e.addEventListener("error",handleAudioError),s.isActive&&!s.isPaused&&playAudio(),()=>{t=!1,e.removeEventListener("ended",handleAudioEnd),e.removeEventListener("error",handleAudioError)}},[p,s.isActive,s.isPaused,s.currentRepeat,h.audioSettings,I,k,T]),(0,n.useEffect)(()=>{console.log("Current item changed, resetting repeat count"),T(0)},[null==p?void 0:p.id,T]),(0,n.useEffect)(()=>{s.isActive||0!==s.remainingTime||t.push("/practice/dictation/result")},[s.isActive,s.remainingTime,t]),s.isActive)?(0,i.jsxs)(u.Z,{fullHeight:!0,children:[(0,i.jsx)(r(),{children:(0,i.jsx)("title",{children:"zh"===a?"听写练习中 - Just Gojuon":"Dictation in Progress - Just Gojuon"})}),(0,i.jsx)(d.Z,{className:"py-8 h-full",children:(0,i.jsxs)("div",{className:"max-w-4xl mx-auto h-full flex flex-col",children:[(0,i.jsx)(x.Z,{className:"mb-6",children:(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{className:"flex items-center space-x-6",children:[(0,i.jsxs)("div",{className:"text-center",children:[(0,i.jsx)("div",{className:"text-2xl font-bold text-primary-600",children:(e=s.remainingTime,"".concat(Math.floor(e/60).toString().padStart(2,"0"),":").concat((e%60).toString().padStart(2,"0")))}),(0,i.jsx)("div",{className:"text-xs text-text-secondary",children:"zh"===a?"剩余时间":"Time Left"})]}),(0,i.jsxs)("div",{className:"text-center",children:[(0,i.jsxs)("div",{className:"text-lg font-semibold text-text-primary",children:[s.currentAudioIndex+1," / ",s.totalAudios]}),(0,i.jsx)("div",{className:"text-xs text-text-secondary",children:"zh"===a?"音频进度":"Audio Progress"})]}),(0,i.jsxs)("div",{className:"text-center",children:[(0,i.jsxs)("div",{className:"text-lg font-semibold text-text-primary",children:[s.currentRepeat+1," / ",h.audioSettings.repeatCount]}),(0,i.jsx)("div",{className:"text-xs text-text-secondary",children:"zh"===a?"重复次数":"Repetition"})]})]}),(0,i.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,i.jsx)("div",{className:"w-32 h-2 bg-gray-200 rounded-full overflow-hidden",children:(0,i.jsx)("div",{className:"h-full bg-gradient-to-r from-primary-500 to-japanese-accent transition-all duration-1000",style:{width:"".concat(getProgress(),"%")}})}),(0,i.jsxs)("span",{className:"text-sm font-medium text-text-primary",children:[getProgress(),"%"]})]})]})}),(0,i.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,i.jsx)(x.Z,{className:"w-full max-w-2xl text-center",children:(0,i.jsxs)("div",{className:"py-12",children:[(0,i.jsxs)("div",{className:"mb-8",children:[(0,i.jsx)("div",{className:"inline-flex items-center justify-center w-24 h-24 rounded-full mb-6 ".concat(S?"bg-japanese-hiragana animate-pulse":"bg-gray-300"),children:(0,i.jsx)("span",{className:"text-white text-3xl",children:S?"\uD83D\uDD0A":"\uD83D\uDD07"})}),(0,i.jsx)("h2",{className:"text-2xl font-bold text-text-primary mb-2",children:"zh"===a?"正在播放音频":"Playing Audio"})]}),(0,i.jsx)("div",{className:"mb-8 p-4 bg-primary-50 rounded-card",children:(0,i.jsxs)("div",{className:"flex items-center gap-2 text-primary-700 text-sm",children:[(0,i.jsx)(g.Z,{className:"w-4 h-4 flex-shrink-0"}),(0,i.jsx)("p",{children:"zh"===a?"请在纸上写下您听到的假名字符或罗马音":"Please write down the kana characters or romaji you hear on paper"})]})}),(0,i.jsxs)("div",{className:"flex items-center justify-center space-x-4",children:[(0,i.jsxs)(m.Z,{variant:"outline",size:"lg",onClick:()=>{C.current&&C.current.pause(),j()},disabled:s.totalAudios<=1,children:["⏮️ ","zh"===a?"上一个":"Previous"]}),(0,i.jsxs)(m.Z,{variant:s.isPaused?"primary":"secondary",size:"lg",onClick:()=>{s.isPaused?y():(f(),C.current&&C.current.pause())},children:[s.isPaused?"▶️":"⏸️",s.isPaused?"zh"===a?"继续":"Resume":"zh"===a?"暂停":"Pause"]}),(0,i.jsxs)(m.Z,{variant:"outline",size:"lg",onClick:()=>{C.current&&C.current.pause(),v()},disabled:s.totalAudios<=1,children:["⏭️ ","zh"===a?"下一个":"Next"]}),(0,i.jsxs)(m.Z,{variant:"outline",size:"lg",onClick:()=>{A(),C.current&&C.current.pause(),t.push("/practice/dictation/result")},children:["⏹️ ","zh"===a?"停止":"Stop"]})]})]})})}),p&&(0,i.jsx)("audio",{ref:C,src:p.audioUrl,preload:"auto"})]})})]}):(0,i.jsx)(u.Z,{children:(0,i.jsx)(d.Z,{className:"py-8 text-center",children:(0,i.jsxs)(x.Z,{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-text-primary mb-4",children:"zh"===a?"练习未开始":"Practice Not Started"}),(0,i.jsx)("p",{className:"text-text-secondary mb-6",children:"zh"===a?"请先配置练习设置":"Please configure practice settings first"}),(0,i.jsx)(m.Z,{onClick:()=>t.push("/practice/dictation"),children:"zh"===a?"返回配置":"Back to Config"})]})})})}},5274:function(e,t,a){"use strict";a.d(t,{Gq:function(){return useDictationStats},NT:function(){return useDictationConfig},Uf:function(){return d},m:function(){return useDictationState},o9:function(){return useCurrentAudioItem}});var i=a(4529),n=a(782),s=a(5231),r=a(8421),o=a(4920);let l={selectedCategories:[s.B.SEION],duration:5,audioSettings:{volume:.8,playbackRate:1,intervalTime:2,repeatCount:3}},c={isActive:!1,isPaused:!1,currentAudioIndex:0,totalAudios:0,remainingTime:0,playedCount:0,currentRepeat:0},u={totalPlayed:0,sessionDuration:0,categoriesUsed:[],startTime:new Date,playedAudios:[]},d=(0,i.Ue)()((0,n.tJ)((e,t)=>({config:l,state:c,stats:u,playlist:[],currentItem:null,updateConfig:t=>{e(e=>({config:{...e.config,...t}}))},updateAudioSettings:t=>{e(e=>({config:{...e.config,audioSettings:{...e.config.audioSettings,...t}}}))},generatePlaylist:()=>{let{config:a}=t(),i=a.selectedCategories.flatMap(e=>(0,o.uY)(e)),n=(0,o.Sy)(i).map((e,t)=>({id:"audio-".concat(t),kanaId:e.id,audioUrl:(0,o.pm)(e),category:e.category,hiragana:e.hiragana,katakana:e.katakana,romaji:e.romaji}));e({playlist:n,state:{...t().state,totalAudios:n.length,currentAudioIndex:0},currentItem:n[0]||null})},startDictation:()=>{let{config:a}=t();t().generatePlaylist(),e({state:{...c,isActive:!0,remainingTime:60*a.duration,totalAudios:t().playlist.length},stats:{...u,startTime:new Date,categoriesUsed:a.selectedCategories,playedAudios:[]}})},pauseDictation:()=>{e(e=>({state:{...e.state,isPaused:!0}}))},resumeDictation:()=>{e(e=>({state:{...e.state,isPaused:!1}}))},stopDictation:()=>{let a=t().stats,i=a.startTime,n=new Date,s=Math.floor((n.getTime()-i.getTime())/1e3);e({state:c,stats:{...a,endTime:n,sessionDuration:s},currentItem:null})},nextAudio:()=>{let{state:a,playlist:i}=t(),n=a.currentAudioIndex+1;if(console.log("nextAudio called, current index:",a.currentAudioIndex,"next index:",n,"playlist length:",i.length),n<i.length){var s;console.log("Moving to next audio:",null===(s=i[n])||void 0===s?void 0:s.romaji),e({state:{...a,currentAudioIndex:n,playedCount:a.playedCount+1,currentRepeat:0},currentItem:i[n]||null})}else{console.log("All audios completed, stopping dictation");let a=t().stats,i=a.startTime,n=new Date,s=Math.floor((n.getTime()-i.getTime())/1e3);e({state:{...t().state,isActive:!1,remainingTime:0},stats:{...a,endTime:n,sessionDuration:s}})}},previousAudio:()=>{let{state:a,playlist:i}=t(),n=a.currentAudioIndex>0?a.currentAudioIndex-1:i.length-1;e({state:{...a,currentAudioIndex:n,currentRepeat:0},currentItem:i[n]||null})},updateTimer:()=>{let{state:a}=t();a.isActive&&!a.isPaused&&a.remainingTime>0&&(e(e=>({state:{...e.state,remainingTime:e.state.remainingTime-1}})),a.remainingTime<=1&&t().stopDictation())},resetConfig:()=>{e({config:l})},recordAudioPlayed:(t,a)=>{let i={kanaId:t.kanaId,hiragana:t.hiragana,katakana:t.katakana,romaji:t.romaji,category:t.category,playedAt:new Date,repeatCount:a};e(e=>({stats:{...e.stats,totalPlayed:e.stats.totalPlayed+1,playedAudios:[...e.stats.playedAudios,i]}}))},updateCurrentRepeat:t=>{e(e=>({state:{...e.state,currentRepeat:t}}))},resetStats:()=>{e({stats:u})}}),{name:r.I.USER_SETTINGS+"-dictation",partialize:e=>({config:e.config,stats:e.stats})})),useDictationConfig=()=>d(e=>e.config),useDictationState=()=>d(e=>e.state),useDictationStats=()=>d(e=>e.stats),useCurrentAudioItem=()=>d(e=>e.currentItem)},4920:function(e,t,a){"use strict";a.d(t,{LN:function(){return getKanaCategoryColor},OA:function(){return getKanaDisplayText},Sy:function(){return shuffleArray},pm:function(){return getKanaAudioUrl},uY:function(){return getKanaByCategory}});var i=a(5231),n=a(6886);let getKanaByCategory=e=>e?n.IC[e]||[]:n.q,shuffleArray=e=>{let t=[...e];for(let e=t.length-1;e>0;e--){let a=Math.floor(Math.random()*(e+1));[t[e],t[a]]=[t[a],t[e]]}return t},getKanaDisplayText=(e,t)=>t===i.k.HIRAGANA?e.hiragana:e.katakana,getKanaCategoryColor=e=>{let t={[i.B.SEION]:"text-japanese-hiragana",[i.B.DAKUON]:"text-japanese-katakana",[i.B.HANDAKUON]:"text-japanese-romaji",[i.B.YOON]:"text-japanese-accent"};return t[e]||"text-gray-600"},getKanaAudioUrl=e=>{let t={[i.B.SEION]:"seion",[i.B.DAKUON]:"dakuon",[i.B.HANDAKUON]:"handakuon",[i.B.YOON]:"yoon"},a=t[e.category];return"/sounds/".concat(a,"/").concat(e.romaji,".mp3")}}},function(e){e.O(0,[372,886,774,888,179],function(){return e(e.s=1578)}),_N_E=e.O()}]);